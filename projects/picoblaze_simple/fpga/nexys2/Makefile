
PROJECT = picoblaze_simple
FPGA = xc3s500e-5-fg320
PLATFORM = Nexys2
INDEX = 0
APPLICATION = echo

##
## Files needed or generated by this build
##
XST_FILE = $(PROJECT).xst
PRJ_FILE = $(PROJECT).prj

SYNTHESIS_LOG_FILE = $(PROJECT).syr
SYNTHESIS_OUTPUT = $(PROJECT).ngc
NGDBUILD_OUTPUT = $(PROJECT).ngd
PCF_FILE = $(PROJECT).pcf
MAP_OUTPUT = $(PROJECT)_map.ncd
PAR_OUTPUT = $(PROJECT).ncd
BITGEN_OUTPUT = $(PROJECT).bit
TIMING_OUTPUT = $(PROJECT).twr
NETGEN_OUTPUT = $(PROJECT)_timesim.v
UCF_FILE = ./nexys2.ucf

##
## Executables used for this process
##
RM = rm -rf 
MKDIR = mkdir
XST = xst
NGDBUILD = ngdbuild
MAP = map
PAR = par
TRCE = trce
NETGEN =netgen
BITGEN = bitgen
NETGEN = netgen
TRCE = trce
DJTGCFG = djtgcfg
BUILD_FPGA = build_fpga.py
MAKE = make

all: $(BITGEN_OUTPUT) 

$(PRJ_FILE):
	$(MAKE) -C ../../software/applications/$(APPLICATION)
	$(BUILD_FPGA) -d -x -f ./nexys2.cfg -r ../../

$(SYNTHESIS_OUTPUT): $(PRJ_FILE) 
	$(RM) ./xst
	$(MKDIR) xst
	$(MKDIR) xst/projnav.tmp
	$(XST) -ifn $(XST_FILE) -ofn  $(SYNTHESIS_LOG_FILE)

$(NGDBUILD_OUTPUT): $(SYNTHESIS_OUTPUT)
	$(NGDBUILD) -intstyle ise -p $(FPGA) $(SYNTHESIS_OUTPUT) $(NGDBUILD_OUTPUT) -uc $(UCF_FILE)

$(MAP_OUTPUT): $(NGDBUILD_OUTPUT)
	$(MAP) -intstyle ise -p $(FPGA) -o $(MAP_OUTPUT) $(NGDBUILD_OUTPUT) $(PCF_FILE)

$(PAR_OUTPUT): $(MAP_OUTPUT)
	$(PAR) -intstyle ise $(MAP_OUTPUT) $(PAR_OUTPUT) $(PCF_FILE)

$(BITGEN_OUTPUT): $(PAR_OUTPUT)
	$(BITGEN)  -intstyle ise -w -g StartupClk:JtagClk $(PAR_OUTPUT)

download:
	$(DJTGCFG) init -d $(PLATFORM)
	$(DJTGCFG) prog -d $(PLATFORM) -i $(INDEX) -f $(BITGEN_OUTPUT)
timing: $(BITGEN_OUTPUT) 
	$(TRCE) -intstyle ise -o $(TIMING_OUTPUT) $(PAR_OUTPUT) $(PCF_FILE)
sim: $(BITGEN_OUTPUT) 
	$(NETGEN) -intstyle ise -sdf_anno false -insert_glbl true -w -ofmt verilog -dir netgen/par -pcf $(PCF_FILE) -sim $(PAR_OUTPUT) $(NETGEN_OUTPUT)

clean:
	$(RM) ./xst/ $(SYNTHESIS_LOG_FILE) $(SYNTHESIS_OUTPUT) $(NGDBUILD_OUTPUT) $(MAP_OUTPUT) $(PAR_OUTPUT) $(BITGEN_OUTPUT) $(PROJECT).pcf *.xrpt _xmsgs/ xlnx_auto_0_xdb/ *.lst *~ *log *xml *html *.csv *.txt *bgn *xwbt *bld *lso *drc *par *map *mrp *ngm *pad *ptwx *unroutes *xpi netgen/ $(TIMING_OUTPUT) *.twx $(XST_FILE) $(PRJ_FILE)
	$(MAKE) -C ../../software/applications/$(APPLICATION) clean